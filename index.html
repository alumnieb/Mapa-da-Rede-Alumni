<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Mapa da Rede Alumni Ensina Brasil</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <!-- Fonte estilo Ensina -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap"
    rel="stylesheet"
  />

  <style>
    :root {
      --ensina-blue: #004b8d;
      --ensina-blue-dark: #003767;
      --ensina-green: #00bfa5;
      --bg-light: #f4f6fb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --card-bg: #ffffff;
      --border-soft: #e5e7eb;
    }

    .linkedin-link {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.78rem;
      color: var(--ensina-blue);
      text-decoration: none;
    }

    .linkedin-link:hover {
      text-decoration: underline;
    }

    .linkedin-icon {
      width: 14px;
      height: 14px;
      display: inline-block;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
      margin: 0;
      background: var(--bg-light);
      color: var(--text-main);
    }

    header {
      padding: 14px 24px;
      background: linear-gradient(
        90deg,
        var(--ensina-blue-dark),
        var(--ensina-blue)
      );
      color: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    header h1 {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 600;
    }

    header span {
      font-size: 0.8rem;
      opacity: 0.85;
    }

    .page-wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    /* Card institucional */
    .intro-card {
      background: var(--card-bg);
      border-radius: 14px;
      padding: 16px 18px 14px;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
      border: 1px solid rgba(148, 163, 184, 0.3);
      margin-bottom: 16px;
    }

    .intro-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(0, 191, 165, 0.08);
      color: var(--ensina-blue-dark);
      font-size: 0.75rem;
      font-weight: 500;
      margin-bottom: 6px;
    }

    .intro-chip-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--ensina-green);
    }

    .intro-card h2 {
      margin: 2px 0 4px;
      font-size: 1.05rem;
      font-weight: 600;
      color: var(--ensina-blue-dark);
    }

    .intro-card p {
      margin: 3px 0;
      font-size: 0.87rem;
      line-height: 1.5;
      color: var(--text-muted);
    }

    main {
      display: grid;
      grid-template-columns: 1.4fr 1fr;
      gap: 16px;
      align-items: stretch;   /* colunas com mesma altura */
    }

    .map-wrapper {
      display: flex;
      flex-direction: column;
      height: 72vh;      /* altura igual ao painel */
      position: relative;
    }

    #map {
      width: 100%;
      height: 100%;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    .panel {
      background: var(--card-bg);
      border-radius: 14px;
      padding: 14px 14px 12px;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
      border: 1px solid rgba(148, 163, 184, 0.4);
      display: flex;
      flex-direction: column;
      height: 72vh;
    }

    /* Container para bot√£o Home + legendas */
    .map-top-right {
      position: absolute;
      top: 12px;
      right: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 520;
    }

    .map-home-btn {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.9);
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 17px;
      cursor: pointer;
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.15);
      z-index: 1;
      transition: transform 0.15s, box-shadow 0.15s, border-color 0.15s;
    }

    .map-home-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 26px rgba(15, 23, 42, 0.22);
      border-color: var(--ensina-blue);
    }

    /* Legenda da logo do Ensina */
    .ensina-legend {
      font-size: 0.78rem;
      color: var(--text-muted);
      background: rgba(255, 255, 255, 0.95);
      border-radius: 999px;
      padding: 4px 8px 4px 4px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.15);
      border: 1px solid rgba(209, 213, 219, 0.9);
      cursor: default;
      transition: border-color 0.2s ease, color 0.2s ease;
    }

    .ensina-legend-logo {
      width: 24px;
      height: 24px;
      border-radius: 999px;
      background-color: #ffffff;
      border: 2px solid rgba(15, 23, 42, 0.15);
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.25);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      flex-shrink: 0;
    }

    .ensina-legend-logo img {
      width: 90%;
      height: 90%;
      object-fit: contain;
    }

    /* Tooltip de nome do estado */
    .estado-tooltip.leaflet-tooltip {
      background: rgba(17, 24, 39, 0.95);
      color: #fff;
      border-radius: 6px;
      padding: 6px 8px;
      box-shadow: 0 6px 18px rgba(15,23,42,0.32);
      font-weight: 600;
      font-size: 13px;
    }

    /* Remove outline/stroke preto ao selecionar/clicar nos estados */
    .leaflet-path {
      outline: none !important;
    }

    .ensina-legend-text {
      opacity: 0;
      max-width: 0;
      white-space: nowrap;
      overflow: hidden;
      transition: opacity 0.2s ease, max-width 0.2s ease;
    }

    .ensina-legend:hover .ensina-legend-text {
      opacity: 1;
      max-width: 260px;
    }

    /* Modo polo: borda e texto em azul escuro */
    .ensina-legend.ensina-legend--polo {
      border-color: var(--ensina-blue-dark);
      color: var(--ensina-blue-dark);
    }

    /* ========= LEGENDA LAMPIAR ========= */
    .lampiar-legend {
      font-size: 0.78rem;
      color: var(--text-muted);
      background: rgba(255, 255, 255, 0.95);
      border-radius: 999px;
      padding: 4px 8px 4px 4px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.15);
      border: 1px solid rgba(209, 213, 219, 0.9);
      cursor: default;
      transition: border-color 0.2s ease, color 0.2s ease;
    }

    .lampiar-legend-logo {
      width: 24px;
      height: 24px;
      border-radius: 999px;
      background-color: #ffffff;
      border: 2px solid rgba(15, 23, 42, 0.15);
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.25);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      flex-shrink: 0;
    }

    .lampiar-legend-logo img {
      width: 125%;
      height: 125%;
      object-fit: cover;
      border-radius: 50%;
    }

    .lampiar-legend-text {
      opacity: 0;
      max-width: 0;
      white-space: nowrap;
      overflow: hidden;
      transition: opacity 0.2s ease, max-width 0.2s ease;
    }

    .lampiar-legend:hover .lampiar-legend-text {
      opacity: 1;
      max-width: 360px;
    }

    /* leve offset horizontal se quiser diferenciar visualmente o √≠cone Lampiar */
    /* leve offset horizontal s√≥ na logo do Lampiar na legenda (n√£o nos marcadores do mapa) */
.lampiar-legend .logo-lampiar {
  transform: translateX(18px);
}

    .panel h2 {
      margin: 0 0 8px;
      font-size: 1rem;
      font-weight: 600;
      color: var(--ensina-blue-dark);
    }

    .filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 6px 10px;
      margin-bottom: 6px;
    }

    .filters label {
      display: flex;
      flex-direction: column;
      font-size: 0.78rem;
      gap: 3px;
      color: var(--text-main);
    }

    .filters-actions {
      display: grid;
      grid-template-columns: auto 1fr;
      align-items: center;
      gap: 8px;
      grid-column: 1 / -1;
      padding-top: 2px;
    }

    .filters-actions #summary {
      font-size: 0.83rem;
      color: var(--text-muted);
      line-height: 1.3;
    }

    select {
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 0.86rem;
      background: #f9fafb;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s, background 0.15s;
    }

    select:focus {
      border-color: var(--ensina-green);
      box-shadow: 0 0 0 1px rgba(0, 191, 165, 0.4);
      background: #ffffff;
    }

    .btn-limpar {
      margin-bottom: 10px;
      padding: 6px 10px;
      border-radius: 999px;
      background: #ffffff;
      border: 1px solid var(--ensina-green);
      color: var(--ensina-blue-dark);
      font-size: 0.8rem;
      cursor: pointer;
      transition: 0.15s;
      align-self: flex-start;
    }

    .btn-limpar:hover {
      background: var(--ensina-green);
      color: white;
      transform: translateY(-1px);
    }

    #summary {
      font-size: 0.82rem;
      margin-bottom: 6px;
      color: var(--text-muted);
    }

    #people-list {
      overflow-y: auto;
      flex: 1;
      border-top: 1px solid #e5e7eb;
      margin-top: 6px;
      padding-top: 6px;
    }

    .person-card {
      padding: 7px 8px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      margin-bottom: 6px;
      background: #ffffff;
      transition: box-shadow 0.15s, transform 0.1s, border-color 0.15s, opacity 0.15s;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .person-card:hover {
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.08);
      transform: translateY(-1px);
      border-color: rgba(0, 191, 165, 0.35);
    }

    .person-main-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .person-main-left {
      flex: 1;
      min-width: 140px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .person-main-left strong {
      display: block;
      font-size: 0.9rem;
      margin-bottom: 0;
    }

    .person-main-middle {
      flex: 1;
      display: flex;
      justify-content: center;
      transform: translateX(-12px);
    }

    .linkedin-line {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: 2px;
      font-size: 0.8rem;
    }

    .linkedin-icon {
      width: 16px;
      height: 16px;
      object-fit: contain;
      border-radius: 3px;
    }

    .person-main-right {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.82rem;
      color: var(--text-muted);
      white-space: nowrap;
    }

    .person-flag {
      width: 40px;
      aspect-ratio: 4 / 3;
      object-fit: contain;
      border-radius: 4px;
      border: 1px solid #d1d5db;
      background: white;
      padding: 1px;
    }

    .person-bottom-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .person-card.selected {
      border-color: rgba(0, 75, 141, 0.8);
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.16);
      transform: translateY(-1px);
      background: #ecfeff;
      opacity: 1;
    }

    .person-card.dimmed {
      opacity: 0.45;
    }

    .person-avatar {
      width: 42px;
      height: 42px;
      border-radius: 6px;
      object-fit: contain;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      flex-shrink: 0;
    }

    .badge {
      display: inline-block;
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 0.7rem;
      margin-right: 4px;
      margin-bottom: 3px;
      font-weight: 500;
    }

    .badge-role {
      background: rgba(0, 75, 141, 0.08);
      color: var(--ensina-blue-dark);
      border: 1px solid rgba(0, 75, 141, 0.25);
    }

    .badge-inst {
      background: rgba(0, 191, 165, 0.08);
      color: var(--ensina-blue-dark);
      border: 1px solid rgba(0, 191, 165, 0.25);
    }

    .badge-turma {
      background: #eef2ff;
      color: #3730a3;
      border: 1px solid #c7d2fe;
    }

    a {
      color: var(--ensina-blue);
      text-decoration: none;
      font-weight: 500;
    }

    a:hover {
      text-decoration: underline;
    }

    footer {
      margin-top: 20px;
      padding: 12px 0 6px;
      border-top: 1px solid rgba(148, 163, 184, 0.5);
      font-size: 0.78rem;
      color: var(--text-muted);
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    footer strong {
      color: var(--ensina-blue-dark);
      font-weight: 600;
    }

    /* Se√ß√£o de cadastro no mapa */
    .join-section {
      margin-top: 18px;
      background: var(--card-bg);
      border-radius: 14px;
      padding: 14px 16px;
      box-shadow: 0 10px 26px rgba(15, 23, 42, 0.08);
      border: 1px solid rgba(148, 163, 184, 0.35);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .join-section-text {
      font-size: 0.88rem;
      color: var(--text-muted);
    }

    .join-section-text strong {
      display: block;
      font-size: 0.95rem;
      color: var(--ensina-blue-dark);
      margin-bottom: 4px;
    }

    .btn-cadastro {
      border: none;
      border-radius: 999px;
      padding: 8px 18px;
      font-size: 0.86rem;
      font-weight: 600;
      background: var(--ensina-blue);
      color: #ffffff;
      cursor: pointer;
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.25);
      transition: background 0.15s, transform 0.1s, box-shadow 0.15s;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .btn-cadastro:hover {
      background: var(--ensina-blue-dark);
      transform: translateY(-1px);
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.3);
    }

    .btn-cadastro:active {
      transform: translateY(0);
      box-shadow: 0 6px 16px rgba(15, 23, 42, 0.2);
    }

    /* Popup quando n√£o h√° alumni no estado selecionado */
    .no-alumni-popup {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, 0.45);
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }

    .no-alumni-popup.show {
      opacity: 1;
      pointer-events: auto;
    }

    .no-alumni-popup-content {
      background: #ffffff;
      padding: 18px 20px 16px;
      border-radius: 14px;
      max-width: 360px;
      width: 90%;
      box-shadow: 0 20px 45px rgba(15, 23, 42, 0.25);
      border: 1px solid rgba(148, 163, 184, 0.5);
      font-size: 0.9rem;
    }

    .no-alumni-popup-content h3 {
      margin: 0 0 8px;
      font-size: 1rem;
      color: var(--ensina-blue-dark);
      font-weight: 600;
    }

    .no-alumni-popup-content p {
      margin: 0 0 12px;
      color: var(--text-muted);
      line-height: 1.4;
    }

    .popup-close-btn {
      border: none;
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 0.85rem;
      font-weight: 500;
      background: var(--ensina-blue);
      color: #ffffff;
      cursor: pointer;
      transition: background 0.15s, transform 0.1s, box-shadow 0.15s;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.25);
    }

    .popup-close-btn:hover {
      background: var(--ensina-blue-dark);
      transform: translateY(-1px);
      box-shadow: 0 10px 26px rgba(15, 23, 42, 0.3);
    }

    .popup-close-btn:active {
      transform: translateY(0);
      box-shadow: 0 5px 16px rgba(15, 23, 42, 0.22);
    }

    /* Logo markers (estado e munic√≠pio) */
    .logo-marker {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      background-color: #ffffff;
      border: 2px solid rgba(15, 23, 42, 0.15);
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.25);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      transition: transform 160ms ease, box-shadow 160ms ease;
    }

    .logo-marker img {
      width: 90%;
      height: 90%;
      object-fit: contain;
      transition: transform 160ms ease;
    }

    /* destaque ao passar o mouse para logos (Ensina/Lampiar) */
    .ensina-legend-logo:hover,
    .logo-marker.logo-municipal:hover,
    .logo-marker.logo-polo-state:hover,
    .logo-marker.logo-lampiar:hover,
    .logo-marker--hover {
      transform: scale(1.18);
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.32);
    }

    .logo-marker.logo-municipal {
      border-color: var(--ensina-blue);
    }

    .logo-marker.logo-polo-state {
      border-color: #002b55;
      border-width: 2px;
      border-style: solid;
      box-shadow: 0 6px 16px rgba(0, 43, 85, 0.18);
    }

    /* Logos de programas (bandeiras) come√ßam opacas e clareiam no hover */
    .logo-marker.logo-program {
      opacity: 0.55;
      transition: opacity 160ms ease, transform 160ms ease, box-shadow 160ms ease;
    }

    .logo-marker.logo-program.logo-marker--hover,
    .logo-marker.logo-program:hover {
      opacity: 1;
    }

    /* efeito ativo (clique) nos logos */
    .logo-marker--active {
      transform: scale(1.25) !important;
      box-shadow: 0 8px 24px rgba(15,23,42,0.36) !important;
      transition: transform 180ms ease, box-shadow 180ms ease;
    }

    @media (max-width: 900px) {
      main {
        grid-template-columns: 1fr;
      }

      #map,
      .panel {
        max-height: none;
        height: 55vh;
      }

      .panel {
        height: auto;
      }

      .map-top-right {
        top: 8px;
        right: 8px;
      }

      .join-section {
        flex-direction: column;
        align-items: flex-start;
      }

      .btn-cadastro {
        align-self: stretch;
        text-align: center;
      }
    }
    .logo-lampiar {
  z-index: 9999;
}

    /* Ajuste base dos √≠cones Lampiar (cobre a √°rea para eliminar bordas brancas) */
    .logo-marker.logo-lampiar img {
      width: 125%;
      height: 125%;
      object-fit: cover;
      border-radius: 50%;
    }

    /* Ajuste visual dos √≠cones Lampiar em zoom muito baixo */
    .logo-marker.logo-lampiar img.zoomed {
      width: 135% !important;
      height: 135% !important;
      transform: translateX(0) translateY(0) !important;
      object-fit: cover !important;
    }

    /* Tamb√©m aplicar efeito 'zoomed' na imagem da legenda Lampiar */
    .lampiar-legend-logo img.zoomed {
      width: 120% !important;
      height: 120% !important;
      transform: translateX(0) translateY(0) !important;
      object-fit: cover !important;
      transition: transform 160ms ease, width 160ms ease, height 160ms ease;
    }

    .lampiar-legend-logo img {
      transition: transform 160ms ease, width 160ms ease, height 160ms ease;
    }

  </style>
</head>
<body>
  <header>
    <h1>Mapa da Rede Alumni Ensina Brasil</h1>
    <span>Visualiza√ß√£o interna da presen√ßa territorial da rede</span>
  </header>

  <div class="page-wrap">
    <!-- Card institucional -->
    <section class="intro-card">
      <div class="intro-chip">
        <span class="intro-chip-dot"></span>
        Rede alumni em movimento
      </div>
      <h2>Onde estamos atuando pelo Brasil</h2>
      <p>
        Este mapa apresenta, de forma viva e acess√≠vel, a presen√ßa territorial da rede alumni do Ensina. Cada ponto representa alumni que seguem contribuindo para a transforma√ß√£o da educa√ß√£o p√∫blica e da sociedade brasileira em diferentes cidades e contextos. Ele torna vis√≠vel algo que acreditamos profundamente: que a for√ßa da nossa rede est√° na pluralidade de trajet√≥rias que continuam impactando escolas, governos, organiza√ß√µes sociais e iniciativas comunit√°rias em todo o pa√≠s.
      </p>
    </section>

    <main>
      <div class="map-wrapper">
        <div id="map"></div>

        <!-- Bot√£o Home + legendas -->
        <div class="map-top-right">
          <button id="map-home-btn" class="map-home-btn" title="Mapa completo">üè†</button>

          <!-- Legenda Ensina -->
          <div id="ensina-legend" class="ensina-legend"></div>

          <!-- Legenda Lampiar -->
          <div id="lampiar-legend" class="lampiar-legend">
            <div class="lampiar-legend-logo">
              <img src="lampiar.png?v=2" alt="Programa Lampiar" />
            </div>
            <span class="lampiar-legend-text">
              Localidade onde atua o Programa Lampiar
            </span>
          </div>
        </div>
      </div>

      <aside class="panel">
        <h2>Filtros da rede</h2>

        <div class="filters">
          <label>
            Regi√£o
            <select id="filter-regiao">
              <option value="">Todas</option>
            </select>
          </label>
          <label>
            Estado
            <select id="filter-estado">
              <option value="">Todos</option>
            </select>
          </label>
          <label>
            Cidade
            <select id="filter-cidade">
              <option value="">Todas</option>
            </select>
          </label>
          <label>
            Turma
            <select id="filter-turma">
              <option value="">Todas</option>
            </select>
          </label>
          <label>
            Institui√ß√£o
            <select id="filter-instituicao">
              <option value="">Todas</option>
            </select>
          </label>
          <div class="filters-actions">
            <button id="btn-limpar" class="btn-limpar">Limpar sele√ß√£o</button>
            <div id="summary">Carregando dados...</div>
          </div>
        </div>
        <div id="people-list"></div>
      </aside>
    </main>

    <!-- Se√ß√£o de convite para cadastro no mapa -->
    <section class="join-section">
      <div class="join-section-text">
        <strong>Quer aparecer neste mapa? Cadastre-se!</strong>
        <span>
          Este mapa s√≥ existe porque cada trajet√≥ria importa. Se voc√™ √© alumni do Ensina Brasil e ainda n√£o aparece aqui, preencha o formul√°rio abaixo para que possamos incluir sua cidade, √°rea de atua√ß√£o e canal de contato.
        </span>
      </div>
      <a
        href="https://forms.gle/K7C6H93niomnqaHPA"
        class="btn-cadastro"
        target="_blank"
        rel="noopener noreferrer"
      >
        Preencher formul√°rio
      </a>
    </section>

    <footer>
  <strong>Mapa da Rede Alumni Ensina Brasil</strong>
  <span>Criado por Vin√≠cius Prado Pereira ‚Äî Alumni Ensina 2023</span>
  <span>
    Este mapa exibe dados pessoais de alumni que consentiram com sua divulga√ß√£o,
    conforme a Lei Geral de Prote√ß√£o de Dados (Lei 13.709/2018). 
    Para solicitar corre√ß√£o ou remo√ß√£o dos seus dados, escreva para 
    <a href="mailto:seuemail@dominio.com">seuemail@dominio.com</a>.
  </span>
</footer>

  </div> <!-- fim .page-wrap -->

  <!-- Popup: estado sem alumni -->
  <div id="no-alumni-popup" class="no-alumni-popup">
    <div class="no-alumni-popup-content">
      <h3>Nenhum alumni cadastrado nessa localidade</h3>
      <p id="no-alumni-text">
        Nessa localidade n√£o foram cadastrados alumni atuando (por enquanto!).
      </p>
      <button id="popup-close-btn" class="popup-close-btn">Fechar</button>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // -------------------------
    // VARI√ÅVEIS GLOBAIS
    // -------------------------
    let pessoas = [];
    let map;
    let estadosLayer;
    let municipiosLayer = null;
    let paisesVizinhosLayer = null;
    let programasMarkers = [];
    const estadoBoundsBySigla = {};
    const municipiosCache = {};

    let pessoaSelecionadaKey = null;
    let highlightState = null;
    let highlightCityNorm = null;
    let selectedRegion = null; // regi√£o selecionada no filtro

    const stateLogoMarkers = [];        // √≠cones de parceria estadual
    let municipalLogoMarkers = [];      // marcadores din√¢micos (por munic√≠pio)
    let municipalInitialMarkers = [];   // marcadores fixos (agregados ou por cidade)
    let stateExtraCityMarkers = [];     // polos estaduais (zoom)
    let municipalZoomMarkers = [];      // polos municipais (zoom)
    let currentStateLogoZoom = null;    // qual estado est√° em modo polo

    // Lampiar
    let lampiarMarkers = [];

    // DOM
    const filterRegiao = document.getElementById("filter-regiao");
    const filterEstado = document.getElementById("filter-estado");
    const filterCidade = document.getElementById("filter-cidade");
    const filterTurma  = document.getElementById("filter-turma");
    const filterInstituicao = document.getElementById("filter-instituicao");
    const peopleList   = document.getElementById("people-list");
    const summary      = document.getElementById("summary");
    const btnLimpar    = document.getElementById("btn-limpar");
    const mapHomeBtn   = document.getElementById("map-home-btn");

    // Legenda em modo polo ou n√£o
    let poloLegendActive = false;

    // UF atualmente com munic√≠pios carregados
    let currentMunicipiosUF = null;

    // Regi√µes com cores pr√≥prias
    const regionColors = {
      "Norte": "#16a34a",
      "Nordeste": "#f97316",
      "Centro-Oeste": "#8b5cf6",
      "Sudeste": "#0ea5e9",
      "Sul": "#e11d48"
    };

    // Estados com parceria estadual Ensina
    const partnershipStates = ["GO", "MT", "MS"];

    // Cidades com parceria municipal
    const municipalPartnerships = [
      { cidadeNorm: "sao luis", uf: "MA" },
      { cidadeNorm: "vitoria", uf: "ES" },
      { cidadeNorm: "caruaru", uf: "PE" },
      { cidadeNorm: "petrolina", uf: "PE" }
    ];

    // Cidades que devem ter logo j√° no mapa inicial
    const municipalInitialCities = [
      {
        nome: "S√£o Lu√≠s",
        uf: "MA",
        cidadeNorm: "sao luis",
        lat: -2.5307,
        lng: -44.3068
      },
      {
        nome: "Vit√≥ria",
        uf: "ES",
        cidadeNorm: "vitoria",
        lat: -20.3155,
        lng: -40.3128
      },
      {
        nome: "Caruaru",
        uf: "PE",
        cidadeNorm: "caruaru",
        lat: -8.2823,
        lng: -35.9699
      },
      {
        nome: "Petrolina",
        uf: "PE",
        cidadeNorm: "petrolina",
        lat: -9.3891,
        lng: -40.5033
      }
    ];

    // Cidades associadas √†s parcerias estaduais (para polos)
    const statePartnershipCities = {
      GO: [
        { name: "√Åguas Lindas de Goi√°s", lat: -15.7611, lng: -48.2816 },
        { name: "Luzi√¢nia", lat: -16.2530, lng: -47.9500 }
      ],
      MT: [
        { name: "Cuiab√°", lat: -15.6010, lng: -56.0970 }
      ],
      MS: [
        { name: "Campo Grande", lat: -20.4697, lng: -54.6201 }
      ]
    };

    // Mapa de nome -> sigla
    const stateNameToSigla = {
      "Acre": "AC",
      "Alagoas": "AL",
      "Amap√°": "AP",
      "Amazonas": "AM",
      "Bahia": "BA",
      "Cear√°": "CE",
      "Distrito Federal": "DF",
      "Esp√≠rito Santo": "ES",
      "Goi√°s": "GO",
      "Maranh√£o": "MA",
      "Mato Grosso": "MT",
      "Mato Grosso do Sul": "MS",
      "Minas Gerais": "MG",
      "Par√°": "PA",
      "Para√≠ba": "PB",
      "Paran√°": "PR",
      "Pernambuco": "PE",
      "Piau√≠": "PI",
      "Rio de Janeiro": "RJ",
      "Rio Grande do Norte": "RN",
      "Rio Grande do Sul": "RS",
      "Rond√¥nia": "RO",
      "Roraima": "RR",
      "Santa Catarina": "SC",
      "S√£o Paulo": "SP",
      "Sergipe": "SE",
      "Tocantins": "TO"
    };

    // Regi√£o de cada estado
    const stateRegionBySigla = {
      AC: "Norte",
      AL: "Nordeste",
      AP: "Norte",
      AM: "Norte",
      BA: "Nordeste",
      CE: "Nordeste",
      DF: "Centro-Oeste",
      ES: "Sudeste",
      GO: "Centro-Oeste",
      MA: "Nordeste",
      MT: "Centro-Oeste",
      MS: "Centro-Oeste",
      MG: "Sudeste",
      PA: "Norte",
      PB: "Nordeste",
      PR: "Sul",
      PE: "Nordeste",
      PI: "Nordeste",
      RJ: "Sudeste",
      RN: "Nordeste",
      RS: "Sul",
      RO: "Norte",
      RR: "Norte",
      SC: "Sul",
      SP: "Sudeste",
      SE: "Nordeste",
      TO: "Norte"
    };

    // C√≥digo IBGE da UF -> usado no arquivo geojs-XX-mun.json
    const stateCodeBySigla = {
      AC: "12",
      AL: "27",
      AP: "16",
      AM: "13",
      BA: "29",
      CE: "23",
      DF: "53",
      ES: "32",
      GO: "52",
      MA: "21",
      MT: "51",
      MS: "50",
      MG: "31",
      PA: "15",
      PB: "25",
      PR: "41",
      PE: "26",
      PI: "22",
      RJ: "33",
      RN: "24",
      RS: "43",
      RO: "11",
      RR: "14",
      SC: "42",
      SP: "35",
      SE: "28",
      TO: "17"
    };

    // Nome do estado por sigla (pra mensagens)
    const stateNameBySigla = {
      AC: "Acre",
      AL: "Alagoas",
      AP: "Amap√°",
      AM: "Amazonas",
      BA: "Bahia",
      CE: "Cear√°",
      DF: "Distrito Federal",
      ES: "Esp√≠rito Santo",
      GO: "Goi√°s",
      MA: "Maranh√£o",
      MT: "Mato Grosso",
      MS: "Mato Grosso do Sul",
      MG: "Minas Gerais",
      PA: "Par√°",
      PB: "Para√≠ba",
      PR: "Paran√°",
      PE: "Pernambuco",
      PI: "Piau√≠",
      RJ: "Rio de Janeiro",
      RN: "Rio Grande do Norte",
      RS: "Rio Grande do Sul",
      RO: "Rond√¥nia",
      RR: "Roraima",
      SC: "Santa Catarina",
      SP: "S√£o Paulo",
      SE: "Sergipe",
      TO: "Tocantins"
    };

    // √çcone global de logo usando data URL (base64)
    const LOGO_SRC = "data:image/png;base64,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";

    // √çcones
    const ensinaIcon = L.divIcon({
      html: '<div class="logo-marker logo-state"><img src="' + LOGO_SRC + '" alt="Ensina Brasil"></div>',
      className: "",
      iconSize: [26, 26],
      iconAnchor: [13, 13]
    });

    const cityIcon = L.divIcon({
      html: '<div class="logo-marker logo-municipal"><img src="' + LOGO_SRC + '" alt="Ensina Brasil"></div>',
      className: "",
      iconSize: [26, 26],
      iconAnchor: [13, 13]
    });

    const poloIcon = L.divIcon({
      html: '<div class="logo-marker logo-polo-state"><img src="' + LOGO_SRC + '" alt="Polo Ensina Brasil"></div>',
      className: "",
      iconSize: [26, 26],
      iconAnchor: [13, 13]
    });

    // √çcone Lampiar (usa arquivo lampiar.png)
    const lampiarIcon = L.divIcon({
      html: '<div class="logo-marker logo-municipal logo-lampiar"><img src="lampiar.png?v=2" alt="Lampiar"></div>',
      className: "",
      iconSize: [26, 26],
      iconAnchor: [13, 13]
    });

// Helper: adiciona hover de destaque (pequeno zoom + sombra) a um marker de logo
function attachLogoHover(marker) {
  if (!marker) return;
  marker.on('mouseover', function () {
    try {
      const el = this._icon || (this.getElement && this.getElement());
      if (el) {
        const inner = el.querySelector && el.querySelector('.logo-marker');
        if (inner) inner.classList.add('logo-marker--hover');
        else el.classList.add('logo-marker--hover');
      }
    } catch (e) {}
  });
  marker.on('mouseout', function () {
    try {
      const el = this._icon || (this.getElement && this.getElement());
      if (el) {
        const inner = el.querySelector && el.querySelector('.logo-marker');
        if (inner) inner.classList.remove('logo-marker--hover');
        else el.classList.remove('logo-marker--hover');
      }
    } catch (e) {}
  });
}

   // CIDADES DO PROGRAMA LAMPIAR (com deslocamento √† direita ajustado)
const lampiarCities = [
  { nome: "Vit√≥ria", uf: "ES", lat: -19.0, lng: -40.1},

  { nome: "Dourados", uf: "MS", lat: -22.2231, lng: -54.8120 },

  // S√£o Lu√≠s: antes lng -44.2 ‚Üí agora -43.5 (‚âà 0.7¬∞ a leste)
  { nome: "S√£o Lu√≠s", uf: "MA", lat: -3.1, lng: -43.0 }
];


    // Cria a legenda da logo do Ensina sobre o mapa
    function criarLegendaEnsina() {
      const legendEl = document.getElementById("ensina-legend");
      if (!legendEl) return;
      legendEl.innerHTML = `
        <div class="ensina-legend-logo">
          <img src="${LOGO_SRC}" alt="Ensina Brasil" onerror="this.parentElement.innerHTML='<span style=\'font-size:14px; font-weight:bold; color:#004b8d;\'>E</span>'" />
        </div>
        <span class="ensina-legend-text">Localidade onde o Ensina Brasil atua</span>
      `;

      // aplicar hover JS consistente (adiciona classe no elemento interno)
      const logoEl = legendEl.querySelector('.ensina-legend-logo');
      if (logoEl) {
        logoEl.addEventListener('mouseover', () => logoEl.classList.add('logo-marker--hover'));
        logoEl.addEventListener('mouseout', () => logoEl.classList.remove('logo-marker--hover'));
      }
    }

    function setLegendPoloMode(active) {
      const legendEl = document.getElementById("ensina-legend");
      if (!legendEl) return;
      const textSpan = legendEl.querySelector(".ensina-legend-text");
      if (!textSpan) return;

      if (active) {
        legendEl.classList.add("ensina-legend--polo");
        textSpan.textContent = "Polo de atua√ß√£o Ensina Brasil";
        poloLegendActive = true;
      } else {
        legendEl.classList.remove("ensina-legend--polo");
        textSpan.textContent = "Localidade onde o Ensina Brasil atua";
        poloLegendActive = false;
      }
    }

    function getSiglaFromFeature(feature) {
      const props = feature.properties || {};
      return (
        props.sigla ||
        props.SIGLA ||
        stateNameToSigla[props.name] ||
        stateNameToSigla[props.NOME_UF] ||
        ""
      );
    }

    function getNomeFromFeature(feature) {
      const props = feature.properties || {};
      return (
        props.nome ||
        props.NOME_UF ||
        props.name ||
        getSiglaFromFeature(feature) ||
        "Estado"
      );
    }

    // Nome do munic√≠pio em um feature (GeoJSON munic√≠pios)
    function getMunicipioNome(feature) {
      const props = feature.properties || {};
      return (
        props.name ||
        props.NM_MUNICIP ||
        props.NM_MUN ||
        props.NOME ||
        props.nome ||
        ""
      );
    }

    function normalizarTexto(s) {
      return (s || "")
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .toLowerCase()
        .trim();
    }

    // -------------------------
    // POPUP "SEM ALUMNI"
    // -------------------------
    function showNoAlumniPopup(uf) {
      const popup = document.getElementById("no-alumni-popup");
      const textSpan = document.getElementById("no-alumni-text");
      if (!popup || !textSpan) return;

      const nomeEstado = stateNameBySigla[uf] || uf;

      textSpan.textContent =
        `Nessa localidade (${nomeEstado}) n√£o foram cadastrados alumni atuando (por enquanto!).`;

      popup.classList.add("show");
    }

    function hideNoAlumniPopup() {
      const popup = document.getElementById("no-alumni-popup");
      if (!popup) return;
      popup.classList.remove("show");
    }

    // Estilo dos munic√≠pios (para highlight por pessoa)
    function municipioStyle(feature) {
      const nomeMunNorm = normalizarTexto(getMunicipioNome(feature));
      const isHighlight =
        highlightCityNorm &&
        nomeMunNorm === highlightCityNorm;

      const regiao = stateRegionBySigla[currentMunicipiosUF] || "";
      const baseColor = regionColors[regiao] || "#16a34a";

      if (isHighlight) {
        return {
          color: "#0f172a",
          weight: 3,
          fillColor: baseColor,
          fillOpacity: 0.85
        };
      }

      return {
        color: baseColor,
        weight: 2.2,
        fillColor: baseColor,
        fillOpacity: 0.7
      };
    }

    // Avatar: tenta usar a bandeira da UF, sen√£o usa avatar antigo
    function getAvatarUrl(p) {
      const uf = (p.estado_sigla || "").toUpperCase().trim();

      if (uf) {
        return "bandeiras/" + uf + ".png";
      }

      if (p.avatar_url) {
        return p.avatar_url;
      }
      const seed = encodeURIComponent(p.nome || "Alumni Ensina");
      return "https://api.dicebear.com/7.x/thumbs/svg?seed=" + seed;
    }

    // -------------------------
    // MAPA
    // -------------------------
    function initMap() {
      map = L.map("map").setView([-15.5, -52], 4.2);

      L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
        maxZoom: 8,
        minZoom: 3,
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions">CARTO</a>'
      }).addTo(map);

      const brazilBounds = L.latLngBounds(
        L.latLng(-34, -74),
        L.latLng(6, -34)
      );

      map.setMaxBounds(brazilBounds);
      // Drag habilitado com bounds constraint
      map.dragging.enable();

// Limite ampliado para todo o continente americano
const americasBounds = L.latLngBounds(
  L.latLng(-60, -120),  // sudoeste (abaixo da Am√©rica do Sul e mais √† esquerda)
  L.latLng(60, -20)     // nordeste (Canad√° / Groenl√¢ndia aprox.)
);

map.setMaxBounds(americasBounds);
// ‚ùå Remove o panInsideBounds, n√£o precisamos mais dele
// map.on("drag", function () {
//   map.panInsideBounds(americasBounds, { animate: false });
// });
      // Removido: evento de click que voltava para zoom nacional
      // Apenas use os bot√µes e filtros para controlar a navega√ß√£o

      map.on("zoomend", onMapZoomEnd);
    }

    function onMapZoomEnd() {
      if (!map) return;
      const z = map.getZoom();

      const hasFiltersOrSelection =
        pessoaSelecionadaKey ||
        filterRegiao.value ||
        filterEstado.value ||
        filterCidade.value ||
        poloLegendActive;

      if (z <= 5 && !hasFiltersOrSelection) {
        clearStateExtraCityMarkers();
        stateLogoMarkers.forEach(obj => {
          if (!map.hasLayer(obj.marker)) {
            obj.marker.addTo(map);
          }
        });
        currentStateLogoZoom = null;

        municipalInitialMarkers.forEach(init => {
          if (!map.hasLayer(init.marker)) {
            init.marker.addTo(map);
          }
        });

        municipalLogoMarkers.forEach(entry => {
          if (!map.hasLayer(entry.marker)) {
            entry.marker.addTo(map);
          }
        });

        clearMunicipalZoomMarkers();

        highlightState = null;
        highlightCityNorm = null;
        if (estadosLayer) {
          estadosLayer.setStyle(estadoStyle);
        }

        setLegendPoloMode(false);
      }
      // Lampiar continua sempre vis√≠vel (n√£o removemos aqui)
    }

    // Estilo dos estados
function estadoStyle(feature) {
  const sigla = getSiglaFromFeature(feature);
  const regiao = stateRegionBySigla[sigla];
  const baseColor = regionColors[regiao] || "#9ca3af";

  const hasPeople = pessoas && pessoas.some((p) => p.estado_sigla === sigla);
  const isSelectedState = !!highlightState && sigla === highlightState;
  const isInSelectedRegion = !selectedRegion || regiao === selectedRegion;

  // Estados de outra regi√£o quando filtro de regi√£o estiver ativo
  if (selectedRegion && !isInSelectedRegion) {
    return {
      color: "#e5e7eb",
      weight: 1,
      fillColor: "#f9fafb",
      fillOpacity: 0.15,
    };
  }

  // Quando h√° estado destacado, os outros ficam suaves (aplica tamb√©m a estados sem alumni)
  if (highlightState && sigla !== highlightState) {
    return {
      color: "#d1d5db",
      weight: 1,
      fillColor: "#f3f4f6",
      fillOpacity: 0.35,
    };
  }

  // üîπ ESTADO SEM ALUMNI: contorno cinza mais escuro, mas bem suave
  if (!hasPeople) {
    return {
      // mant√©m contorno neutro, mas usa cor da regi√£o com opacidade bem baixa
      color: "#6b7280",
      weight: 1.2,
      fillColor: baseColor,
      fillOpacity: 0.06,
    };
  }

  // Configura√ß√£o padr√£o pra estados com alumni
  let color = baseColor;
  let weight = 2;
  let fillOpacity = 0.18;

  // Quando os munic√≠pios da UF est√£o desenhados, deixa o estado mais ‚Äúde fundo‚Äù
  if (currentMunicipiosUF && sigla === currentMunicipiosUF && municipiosLayer) {
    fillOpacity = 0.08;
    color = "#9ca3af";
  }

  // Estado selecionado (clique ou polo)
  if (isSelectedState) {
    const regionColor = regionColors[regiao] || "#004b8d";

    color = regionColor;
    weight = 3; // um pouco mais fino pra n√£o deformar tanto
    if (currentMunicipiosUF && sigla === currentMunicipiosUF && municipiosLayer) {
      fillOpacity = 0.1;
    } else {
      fillOpacity = 0.3;
    }
  }

  return {
    color,
    weight,
    fillColor: baseColor,
    fillOpacity,
  };
}


    function onEachEstado(feature, layer) {
      const sigla = getSiglaFromFeature(feature);

      if (sigla) {
        estadoBoundsBySigla[sigla] = layer.getBounds();
        const stateName = stateNameBySigla[sigla] || feature.properties && (feature.properties.name || feature.properties.NAME) || sigla;
        // tooltip com nome do estado (abre ao passar o mouse)
        try {
          layer.bindTooltip(stateName, {
            sticky: true,
            direction: 'auto',
            className: 'estado-tooltip',
            opacity: 0.95
          });
        } catch (e) {}
      }

      layer.on("click", () => {
        if (!sigla) return;

        const regiao = stateRegionBySigla[sigla] || "";
        const hasPeople = pessoas && pessoas.some(p => p.estado_sigla === sigla);

        if (!hasPeople) {
          showNoAlumniPopup(sigla);
          return;
        }

        selectedRegion = regiao || null;
        highlightState = sigla;
        highlightCityNorm = null;

        filterRegiao.value = regiao;
        atualizarOpcoesEstado(regiao);
        filterEstado.value = sigla;

        atualizarCidades();
        atualizarLista();

        if (estadosLayer) {
          estadosLayer.setStyle(estadoStyle);
        }

        ajustarZoom();
      });

      layer.on("mouseover", function (e) {
        this.setStyle({
          weight: 4,
          color: "#111827",
          stroke: true
        });
        try { this.openTooltip(e.latlng); } catch (err) {}
      });

      layer.on("mouseout", function () {
        try { this.closeTooltip(); } catch (err) {}
        if (estadosLayer) {
          estadosLayer.resetStyle(this);
        }
      });
    }

    function clearStateExtraCityMarkers() {
      stateExtraCityMarkers.forEach(m => map.removeLayer(m));
      stateExtraCityMarkers = [];
    }

    function clearMunicipalZoomMarkers() {
      municipalZoomMarkers.forEach(obj => map.removeLayer(obj.marker));
      municipalZoomMarkers = [];
    }

    // Clique nas logos de parceria ESTADUAL (GO, MT, MS)
    function handleStateLogoClick(sigla, marker) {
      const citiesClick = statePartnershipCities[sigla] || [];
      const regiao = stateRegionBySigla[sigla] || "";

      if (currentStateLogoZoom === sigla) {
        clearStateExtraCityMarkers();
        clearMunicipalZoomMarkers();

        if (!map.hasLayer(marker)) {
          marker.addTo(map);
        }

        municipalInitialMarkers.forEach(init => {
          if (!map.hasLayer(init.marker)) {
            init.marker.addTo(map);
          }
        });

        municipalLogoMarkers.forEach(entry => {
          if (!map.hasLayer(entry.marker)) {
            entry.marker.addTo(map);
          }
        });

        filterRegiao.value = regiao;
        filterEstado.value = "";
        highlightState = null;
        highlightCityNorm = null;

        atualizarOpcoesEstado(regiao);
        atualizarCidades();
        atualizarLista();
        if (estadosLayer) {
          estadosLayer.setStyle(estadoStyle);
        }

        setLegendPoloMode(false);
        currentStateLogoZoom = null;
        return;
      }

      currentStateLogoZoom = sigla;
      highlightState = sigla;
      highlightCityNorm = null;
      if (estadosLayer) {
        estadosLayer.setStyle(estadoStyle);
      }

      if (citiesClick.length) {
        const latlngs = citiesClick.map(c => [c.lat, c.lng]);

        if (latlngs.length === 1) {
          map.flyTo(latlngs[0], 6.4);
        } else {
          const b = L.latLngBounds(latlngs);
          map.flyToBounds(b, { padding: [20, 20] });
        }

        if (map.hasLayer(marker)) {
          map.removeLayer(marker);
        }

        clearStateExtraCityMarkers();

        citiesClick.forEach(c => {
          const extra = L.marker([c.lat, c.lng], { icon: poloIcon })
            .addTo(map)
            .bindTooltip("Polo de atua√ß√£o Ensina Brasil ‚Äì " + c.name, {
              direction: "top",
              offset: [0, -10],
              opacity: 0.9
            });

          // destaque ao passar o mouse
          attachLogoHover(extra);

          stateExtraCityMarkers.push(extra);
        });

        setLegendPoloMode(true);
      }
    }

    // Clique nas logos de parceria MUNICIPAL
    function handleMunicipalLogoClick(uf, marker) {
      const polos = municipalInitialCities.filter(c => c.uf === uf);
      if (!polos.length) return;

      const latlngs = polos.map(c => [c.lat, c.lng]);
      if (latlngs.length === 1) {
        map.flyTo(latlngs[0], 6.4);
      } else {
        const b = L.latLngBounds(latlngs);
        map.flyToBounds(b, { padding: [20, 20] });
      }

      municipalInitialMarkers.forEach(entry => {
        if (entry.uf === uf && map.hasLayer(entry.marker)) {
          map.removeLayer(entry.marker);
        }
      });

      municipalLogoMarkers.forEach(entry => {
        if (entry.uf === uf && map.hasLayer(entry.marker)) {
          map.removeLayer(entry.marker);
        }
      });

      clearMunicipalZoomMarkers();

      highlightState = uf;
      highlightCityNorm = null;
      if (estadosLayer) {
        estadosLayer.setStyle(estadoStyle);
      }

      polos.forEach(c => {
        const bigMarker = L.marker([c.lat, c.lng], { icon: poloIcon })
          .addTo(map)
          .bindTooltip("Polo de atua√ß√£o Ensina Brasil ‚Äì " + c.nome, {
            direction: "top",
            offset: [0, -10],
            opacity: 0.9
          });

        // destaque ao passar o mouse
        attachLogoHover(bigMarker);

        municipalZoomMarkers.push({ uf, marker: bigMarker });
      });

      setLegendPoloMode(true);
    }

    function carregarEstados() {
      const urlGeoJSON =
        "https://raw.githubusercontent.com/codeforamerica/click_that_hood/master/public/data/brazil-states.geojson";

      fetch(urlGeoJSON)
        .then(r => r.json())
        .then(geo => {
          // Cria a layer de estados
          estadosLayer = L.geoJSON(geo, {
            style: estadoStyle,
            onEachFeature: onEachEstado
          }).addTo(map);

          // Garante que todos os bounds fiquem salvos em estadoBoundsBySigla
          estadosLayer.eachLayer(layer => {
            const sigla = getSiglaFromFeature(layer.feature);
            if (sigla) {
              estadoBoundsBySigla[sigla] = layer.getBounds();
            }
          });

          // Adiciona logos nos estados parceiros (GO, MT, MS)
          partnershipStates.forEach(sigla => {
            const bounds = estadoBoundsBySigla[sigla];
            if (!bounds) return;

            const markerLatLng = bounds.getCenter();

            let tooltipText = "Parceria estadual";
            if (sigla === "GO") tooltipText = "Parceria estadual Goi√°s";
            if (sigla === "MT") tooltipText = "Parceria estadual Mato Grosso";
            if (sigla === "MS") tooltipText = "Parceria estadual Mato Grosso do Sul";

            const marker = L.marker(markerLatLng, { icon: ensinaIcon })
              .addTo(map)
              .bindTooltip(tooltipText, {
                direction: "top",
                offset: [0, -10],
                opacity: 0.9
              });

            marker.on("click", () => handleStateLogoClick(sigla, marker));

            // aplicar destaque hover nas logos de parceria estadual
            try { attachLogoHover(marker); } catch (e) {}
            stateLogoMarkers.push({ sigla, marker });
          });
        })
        .catch(err => {
          console.error("Erro ao carregar GeoJSON de estados:", err);
        });
    }

    // -------------------------
    // PA√çSES VIZINHOS (estilo cinza)
    // -------------------------
    function carregarPaisesVizinhos() {
      const urlGeoJSON =
        "https://nacisworld.org/download/natural-earth/10m/cultural/ne_10m_admin_0_countries.zip";

      // Alternativa: usar um GeoJSON mais simples e acess√≠vel
      const urlSimples = 
        "https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_0_countries.geojson";

      fetch(urlSimples)
        .then(r => r.json())
        .then(geo => {
          // Filtra apenas pa√≠ses da Am√©rica do Sul/Central
          const paisesAmerica = geo.features.filter(f => {
            const props = f.properties || {};
            const continent = props.CONTINENT || "";
            return continent === "South America" || continent === "North America" || continent === "Central America";
          });

          // Exclui o Brasil
          const paisesVizinhos = paisesAmerica.filter(f => {
            const props = f.properties || {};
            return props.NAME !== "Brazil";
          });

          if (paisesVizinhos.length > 0) {
            // estilo base para pa√≠ses vizinhos
            const paisBaseStyle = {
              color: "#6b7280",
              weight: 1.6,
              fillColor: "#f9fafb",
              fillOpacity: 0.18
            };

            paisesVizinhosLayer = L.geoJSON(
              { type: "FeatureCollection", features: paisesVizinhos },
              {
                style: paisBaseStyle,
                onEachFeature: function (feature, layer) {
                  layer.on('mouseover', function () {
                    layer.setStyle({ color: '#0ea5e9', weight: 2.8, fillOpacity: 0.28 });
                  });
                  layer.on('mouseout', function () {
                    layer.setStyle(paisBaseStyle);
                  });
                }
              }
            ).addTo(map);

            // Coloca atr√°s dos estados brasileiros
            if (estadosLayer) {
              estadosLayer.bringToFront();
            }
          }
        })
        .catch(err => {
          console.error("Erro ao carregar GeoJSON de pa√≠ses vizinhos:", err);
        });
    }

    // -------------------------
    // PROGRAMAS TEACH FOR ALL (Ense√±a/Ensina)
    // -------------------------
    function adicionarProgramasTeachForAll() {
      const programas = [
        {
          pais: "Argentina",
          nome: "Ense√±√° por Argentina",
          lat: -38.4161,
          lng: -63.6167,
          logo: "https://cdn.jsdelivr.net/gh/lipis/flag-icons/flags/4x3/ar.svg",
          site: "https://ensenaporargentina.org",
          mostrarSempre: true
        },
        {
          pais: "Bol√≠via",
          nome: "Ense√±a Bolivia",
          lat: -16.5,
          lng: -63.5823,
          logo: "https://cdn.jsdelivr.net/gh/lipis/flag-icons/flags/4x3/bo.svg",
          site: "https://ensenabolivia.org",
          mostrarSempre: true
        },
        {
          pais: "Chile",
          nome: "Ense√±a Chile",
          lat: -30.7191,
          lng: -71.5439,
          logo: "https://cdn.jsdelivr.net/gh/lipis/flag-icons/flags/4x3/cl.svg",
          site: "https://www.ensenachile.cl",
          mostrarSempre: true
        },
        {
          pais: "Col√¥mbia",
          nome: "Ense√±a por Colombia",
          lat: 4.5709,
          lng: -74.2973,
          logo: "https://cdn.jsdelivr.net/gh/lipis/flag-icons/flags/4x3/co.svg",
          site: "https://ensenaporcolombia.org",
          mostrarSempre: true
        },
        {
          pais: "Equador",
          nome: "Ense√±a Ecuador",
          lat: -0.1807,
          lng: -78.4678,
          logo: "https://cdn.jsdelivr.net/gh/lipis/flag-icons/flags/4x3/ec.svg",
          site: "https://ensenaecuador.org",
          mostrarSempre: true
        },
        {
          pais: "M√©xico",
          nome: "Ense√±a por M√©xico",
          lat: 19.4326,
          lng: -99.1332,
          logo: "https://cdn.jsdelivr.net/gh/lipis/flag-icons/flags/4x3/mx.svg",
          site: "https://ensenapormexico.org",
          mostrarSempre: true
        },
        {
          pais: "United States of America",
          nome: "Teach For America",
          lat: 39.8283,
          lng: -98.5795,
          logo: "https://cdn.jsdelivr.net/gh/lipis/flag-icons/flags/4x3/us.svg",
          site: "https://teachforamerica.org",
          mostrarSempre: true
        },
        {
          pais: "Paraguai",
          nome: "Ense√±a Paraguay",
          lat: -25.2637,
          lng: -57.5759,
          logo: "https://cdn.jsdelivr.net/gh/lipis/flag-icons/flags/4x3/py.svg",
          site: "https://ensenaparaguay.org",
          mostrarSempre: true
        },
        {
          pais: "Peru",
          nome: "Ense√±a Per√∫",
          lat: -12.0464,
          lng: -77.0428,
          logo: "https://cdn.jsdelivr.net/gh/lipis/flag-icons/flags/4x3/pe.svg",
          site: "https://ensenaperu.org",
          mostrarSempre: true
        },
        {
          pais: "Uruguai",
          nome: "Ense√±a Uruguay",
          lat: -34.9011,
          lng: -56.1645,
          logo: "https://cdn.jsdelivr.net/gh/lipis/flag-icons/flags/4x3/uy.svg",
          site: "https://www.ensenauruguay.org",
          mostrarSempre: true
        },
        {
          pais: "Panam√°",
          nome: "Ense√±a por Panam√°",
          lat: 8.9824,
          lng: -79.5199,
          logo: "https://cdn.jsdelivr.net/gh/lipis/flag-icons/flags/4x3/pa.svg",
          site: "https://ensenaporpanama.com",
          mostrarSempre: true
        },

        {
          pais: "Haiti",
          nome: "Anseye Pou Ayiti",
          lat: 18.9712,
          lng: -72.2852,
          logo: "https://cdn.jsdelivr.net/gh/lipis/flag-icons/flags/4x3/ht.svg",
          site: "https://anseyepouayiti.org",
          mostrarSempre: true
        }
      ];

      programas.forEach(prog => {
        // helper: cria √≠cone com tamanho vari√°vel (hover aumenta)
        function createIcon(size = 26) {
          return L.divIcon({
            html: `
              <div class="logo-marker logo-program" style="width: ${size}px; height: ${size}px; border-radius: 50%; border: 1.5px solid #004b8d; background: white; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                <img src="${prog.logo}" alt="${prog.pais}" style="width: 85%; height: 85%; object-fit: cover; border-radius: 50%;" onerror="this.parentElement.innerHTML='<span style=\\'font-size: 12px; font-weight: bold; color: #004b8d;\\'>${prog.pais.charAt(0).toUpperCase()}</span>';">
              </div>
            `,
            className: "",
            iconSize: [size, size],
            iconAnchor: [Math.round(size / 2), Math.round(size / 2)]
          });
        }

        const marker = L.marker([prog.lat, prog.lng], { icon: createIcon(26) })
          .bindPopup(`
            <div style="text-align: center; font-weight: 500; font-family: 'Inter', sans-serif;">
              <strong>${prog.pais}</strong><br>
              <span style="font-size: 0.9rem; color: #6b7280;">${prog.nome}</span><br>
              <a href="${prog.site}" target="_blank" rel="noopener noreferrer" style="font-size: 0.85rem; color: #0ea5e9; text-decoration: underline;">Visitar site</a>
            </div>
          `, {
            maxWidth: 200,
            className: "programa-popup"
          });

        // Usamos attachLogoHover para escala/sombra; popup abre no click (n√£o no hover)
        marker.addTo(map);
        try { attachLogoHover(marker); } catch (e) {}
        programasMarkers.push({ marker, prog });
      });


    }



    // -------------------------
    // MUNIC√çPIOS
    // -------------------------
    function limparMunicipios() {
      if (municipiosLayer) {
        map.removeLayer(municipiosLayer);
        municipiosLayer = null;
      }

      currentMunicipiosUF = null;

      municipalLogoMarkers.forEach(obj => map.removeLayer(obj.marker));
      municipalLogoMarkers = [];
    }

    function carregarMunicipiosEstado(sigla) {
      const code = stateCodeBySigla[sigla];
      if (!code) {
        limparMunicipios();
        return;
      }

      currentMunicipiosUF = sigla;

      const cidadesSet = new Set(
        pessoas
          .filter(p => p.estado_sigla === sigla)
          .map(p => normalizarTexto(p.cidade))
          .filter(Boolean)
      );

      if (!cidadesSet.size && !municipalPartnerships.some(pc => pc.uf === sigla)) {
        limparMunicipios();
        return;
      }

      const url = `https://raw.githubusercontent.com/tbrugz/geodata-br/master/geojson/geojs-${code}-mun.json`;

      const desenhar = (geo) => {
        const centersByCidadeNorm = {};
        (geo.features || []).forEach(f => {
          const nomeNorm = normalizarTexto(getMunicipioNome(f));
          if (!nomeNorm) return;
          const tempLayer = L.geoJSON(f);
          centersByCidadeNorm[nomeNorm] = tempLayer.getBounds().getCenter();
        });

        const featuresFiltradas = (geo.features || []).filter(f => {
          const nomeMun = normalizarTexto(getMunicipioNome(f));
          return cidadesSet.has(nomeMun);
        });

        limparMunicipios();
        currentMunicipiosUF = sigla;

        if (featuresFiltradas.length) {
          municipiosLayer = L.geoJSON(
            { type: "FeatureCollection", features: featuresFiltradas },
            {
              style: municipioStyle
            }
          ).addTo(map);

          if (estadosLayer) {
            estadosLayer.setStyle(estadoStyle);
          }
        }

                municipalPartnerships
          .filter(pc => pc.uf === sigla)
          .forEach(pc => {
            // J√° t√™m marcador inicial agregado/individual:
            // n√£o recriar marcador de parceria ao carregar munic√≠pios
            if (sigla === "PE" || sigla === "ES" || sigla === "MA") return;

            const center = centersByCidadeNorm[pc.cidadeNorm];
            if (!center) return;

            const marker = L.marker(center, { icon: cityIcon })
              .addTo(map)
              .bindTooltip("Parceria com Munic√≠pios", {
                direction: "top",
                offset: [0, -10],
                opacity: 0.9
              });

            marker.on("click", () => {
              handleMunicipalLogoClick(sigla, marker);
            });

            municipalLogoMarkers.push({ uf: sigla, marker });
          });

      };

      if (municipiosCache[sigla]) {
        desenhar(municipiosCache[sigla]);
        return;
      }

      fetch(url)
        .then(r => r.json())
        .then(geo => {
          municipiosCache[sigla] = geo;
          desenhar(geo);
        })
        .catch(err => {
          console.error("Erro ao carregar munic√≠pios do estado", sigla, err);
        });
    }

    // -------------------------
    // LOGOS MUNICIPAIS INICIAIS
    // -------------------------
    function adicionarLogosMunicipaisIniciais() {
      const groupedByUF = {};
      municipalInitialCities.forEach(c => {
        if (!groupedByUF[c.uf]) groupedByUF[c.uf] = [];
        groupedByUF[c.uf].push(c);
      });

      Object.keys(groupedByUF).forEach(uf => {
        const cities = groupedByUF[uf];

        if (uf === "PE" || uf === "ES") {
          const latlngs = cities.map(c => [c.lat, c.lng]);
          const bounds = L.latLngBounds(latlngs);
          const center = bounds.getCenter();

          const marker = L.marker(center, { icon: cityIcon })
            .addTo(map)
            .bindTooltip("Parceria com Munic√≠pios", {
              direction: "top",
              offset: [0, -10],
              opacity: 0.9
            });

          marker.on("click", () => {
            handleMunicipalLogoClick(uf, marker);
          });

          // aplicar hover de destaque tamb√©m aos marcadores iniciais
          try { attachLogoHover(marker); } catch (e) {}

          municipalInitialMarkers.push({
            uf,
            nome: "Parceria com Munic√≠pios",
            marker
          });
        } else {
          cities.forEach(cidade => {
            const marker = L.marker([cidade.lat, cidade.lng], { icon: cityIcon })
              .addTo(map)
              .bindTooltip("Parceria com Munic√≠pios", {
                direction: "top",
                offset: [0, -10],
                opacity: 0.9
              });

            marker.on("click", () => {
              handleMunicipalLogoClick(cidade.uf, marker);
            });

            // aplicar hover de destaque tamb√©m aos marcadores municipais individuais
            try { attachLogoHover(marker); } catch (e) {}

            municipalInitialMarkers.push({
              uf: cidade.uf,
              nome: cidade.nome,
              marker
            });
          });
        }
      });
    }

    // -------------------------
    // LOGOS PROGRAMA LAMPIAR
    // -------------------------
    function limparLogosLampiar() {
      lampiarMarkers.forEach(m => map.removeLayer(m));
      lampiarMarkers = [];
    }

function adicionarLogosLampiar() {
  if (!map) return;

  limparLogosLampiar();

  lampiarCities.forEach(cidade => {

    const marker = L.marker([cidade.lat, cidade.lng], { icon: lampiarIcon })
      .addTo(map)
      .bindTooltip(
        "Programa Lampiar ‚Äì " + cidade.nome + "/" + cidade.uf,
        { direction: "top", offset: [0, -10], opacity: 0.9 }
      );

    // üîπ Clique: destacar UF igual ao √≠cone do Ensina + zoom para o estado
    marker.on('click', function () {
      const uf = cidade.uf;
      const regiao = stateRegionBySigla[uf] || "";

      // Atualiza vari√°veis de destaque
      selectedRegion = regiao || null;
      highlightState = uf;
      highlightCityNorm = null;

      // Ajusta filtros da lateral
      filterRegiao.value = regiao;
      atualizarOpcoesEstado(regiao || null);
      filterEstado.value = uf;
      filterCidade.value = "";
      filterTurma.value = "";

      atualizarCidades();
      atualizarLista();

      // Reaplica estilo dos estados para refletir highlightState
      if (estadosLayer) {
        estadosLayer.setStyle(estadoStyle);
      }

      // Carrega munic√≠pios da UF (como nos outros fluxos)
      carregarMunicipiosEstado(uf);

      // Zoom para o estado (usa bounds se tiver, sen√£o vai pro centro)
      try {
        const bounds = estadoBoundsBySigla && estadoBoundsBySigla[uf];
        if (bounds && bounds.isValid && bounds.isValid()) {
          const padded = bounds.pad ? bounds.pad(0.12) : bounds;
          map.fitBounds(padded, { animate: true, maxZoom: 6 });
        } else {
          // fallback: centro do ponto, zoom estadual
          map.flyTo([cidade.lat, cidade.lng], 7);
        }
      } catch (e) {
        // fallback hard caso algo d√™ ruim nos bounds
        map.flyTo([cidade.lat, cidade.lng], 7);
      }
    });

    // hover bonito (escala + sombra)
    attachLogoHover(marker);

    // on hover we also apply a small visual "zoom" to the img (no deslocamento do mapa)
    marker.on('mouseover', function () {
      try {
        const el = marker.getElement && marker.getElement();
        const img = el && el.querySelector && el.querySelector('img');
        if (img) img.classList.add('zoomed');
        try {
          const legend = document.getElementById('lampiar-legend');
          const legendImg = legend && legend.querySelector && legend.querySelector('img');
          if (legendImg) legendImg.classList.add('zoomed');
        } catch (e) {}
      } catch (e) {}
    });
    marker.on('mouseout', function () {
      try {
        const el = marker.getElement && marker.getElement();
        const img = el && el.querySelector && el.querySelector('img');
        if (img) img.classList.remove('zoomed');
        try {
          const legend = document.getElementById('lampiar-legend');
          const legendImg = legend && legend.querySelector && legend.querySelector('img');
          if (legendImg) legendImg.classList.remove('zoomed');
        } catch (e) {}
      } catch (e) {}
    });

    lampiarMarkers.push(marker);
  });
}

// Atualiza a classe visual dos √≠cones Lampiar de acordo com o n√≠vel de zoom do mapa
function updateLampiarIconsByZoom() {
  if (!map) return;
  const zoom = typeof map.getZoom === 'function' ? map.getZoom() : null;
  const MIN_ZOOM = 5;

  lampiarMarkers.forEach(marker => {
    try {
      const el = marker.getElement && marker.getElement();
      if (!el) return;
      const img = el.querySelector && el.querySelector('img');
      if (!img) return;
      if (typeof zoom === 'number' && zoom < MIN_ZOOM) {
        img.classList.add('zoomed');
      } else {
        img.classList.remove('zoomed');
      }
    } catch (e) {}
  });

  // tamb√©m atualizar a imagem da legenda Lampiar
  try {
    const legend = document.getElementById('lampiar-legend');
    const legendImg = legend && legend.querySelector && legend.querySelector('img');
    if (legendImg) {
      if (typeof zoom === 'number' && zoom < MIN_ZOOM) {
        legendImg.classList.add('zoomed');
      } else {
        legendImg.classList.remove('zoomed');
      }
    }
  } catch (e) {}

  // garantir que o handler esteja anexado apenas uma vez
  try {
    if (!window._lampiarZoomHandlerAttached) {
      map.on('zoomend', updateLampiarIconsByZoom);
      window._lampiarZoomHandlerAttached = true;
    }
  } catch (e) {}
}

// Anexa handlers de hover na legenda Lampiar para sincronizar visual com marcadores
function attachLampiarLegendHandlers() {
  try {
    const legend = document.getElementById('lampiar-legend');
    if (!legend) return;
    const legendImg = legend.querySelector && legend.querySelector('img');

    legend.addEventListener('mouseover', function () {
      try {
        if (legendImg) legendImg.classList.add('zoomed');
        lampiarMarkers.forEach(m => {
          try {
            const el = m.getElement && m.getElement();
            const img = el && el.querySelector && el.querySelector('img');
            if (img) img.classList.add('zoomed');
          } catch (e) {}
        });
      } catch (e) {}
    });

    legend.addEventListener('mouseout', function () {
      try {
        if (legendImg) legendImg.classList.remove('zoomed');
        lampiarMarkers.forEach(m => {
          try {
            const el = m.getElement && m.getElement();
            const img = el && el.querySelector && el.querySelector('img');
            if (img) img.classList.remove('zoomed');
          } catch (e) {}
        });
      } catch (e) {}
    });
  } catch (e) {}
}

    // -------------------------
    // ZOOMS
    // -------------------------
    function zoomNacional() {
      highlightState = null;
      highlightCityNorm = null;
      selectedRegion = null;

      if (estadosLayer) {
        estadosLayer.setStyle(estadoStyle);
      }

      if (map) {
        map.flyTo([-15.5, -52], 4.2);
      }

      limparMunicipios();
      clearStateExtraCityMarkers();
      clearMunicipalZoomMarkers();
      currentStateLogoZoom = null;
      setLegendPoloMode(false);
      // Lampiar continua vis√≠vel
    }

    function zoomRegiao(regiao) {
      if (!regiao || !map || !estadosLayer) return;

      const ufs = Object.keys(stateRegionBySigla).filter(
        (sigla) => stateRegionBySigla[sigla] === regiao
      );

      const boundsList = ufs
        .map((sigla) => estadoBoundsBySigla[sigla])
        .filter(Boolean);

      if (!boundsList.length) return;

      let combined = boundsList[0].clone();
      for (let i = 1; i < boundsList.length; i++) {
        combined.extend(boundsList[i]);
      }

      map.flyToBounds(combined, {
        padding: [40, 40],
        maxZoom: 5.2,
        animate: true,
      });
    }

    function zoomEstado(sigla) {
      if (!sigla || !map) return;

      let b = estadoBoundsBySigla[sigla];

      if (!b && estadosLayer) {
        estadosLayer.eachLayer(layer => {
          const s = getSiglaFromFeature(layer.feature);
          if (s === sigla) {
            b = layer.getBounds();
            estadoBoundsBySigla[sigla] = b;
          }
        });
      }

      if (b) {
        map.flyToBounds(b, {
          padding: [40, 40],
          maxZoom: 5.8,
          animate: true
        });
      }

      carregarMunicipiosEstado(sigla);
    }

    function zoomLocal(sigla) {
      const b = estadoBoundsBySigla[sigla];
      if (b) {
        const center = b.getCenter();
        map.flyTo(center, 7);
      }
      carregarMunicipiosEstado(sigla);
    }

    // -------------------------
    // SELE√á√ÉO DE PESSOA
    // -------------------------
    function criarChavePessoa(p) {
      return (p.nome || "") + "|" + (p.estado_sigla || "") + "|" + (p.cidade || "");
    }

    function selecionarPessoa(p) {
      const key = criarChavePessoa(p);
      pessoaSelecionadaKey = key;

      highlightState = p.estado_sigla || null;
      highlightCityNorm = normalizarTexto(p.cidade || "");

      if (p.estado_sigla) {
        filterRegiao.value = stateRegionBySigla[p.estado_sigla] || "";
        atualizarOpcoesEstado(filterRegiao.value || null);
        filterEstado.value = p.estado_sigla;
      }

      atualizarCidades();
      atualizarTurmas();
      atualizarInstituicoes();
      atualizarLista();

      if (estadosLayer) {
        estadosLayer.setStyle(estadoStyle);
      }

      ajustarZoom();
      if (p.estado_sigla) {
        carregarMunicipiosEstado(p.estado_sigla);
      }
    }

    function limparSelecao() {
      pessoaSelecionadaKey = null;
      highlightState = null;
      highlightCityNorm = null;
      selectedRegion = null;

      filterRegiao.value = "";
      filterEstado.value = "";
      filterCidade.value = "";
      filterTurma.value = "";
      filterInstituicao.value = "";

      atualizarOpcoesEstado(null);
      atualizarCidades();
      atualizarTurmas();
      atualizarInstituicoes();
      atualizarLista();

      if (estadosLayer) {
        estadosLayer.setStyle(estadoStyle);
      }

      zoomNacional();
    }

    function ajustarZoom() {
      const regiaoAtual = filterRegiao.value;
      const estadoAtual = filterEstado.value;
      const cidadeAtual = filterCidade.value;

      if (!regiaoAtual && !estadoAtual && !cidadeAtual) {
        zoomNacional();
      } else if (regiaoAtual && !estadoAtual) {
        zoomRegiao(regiaoAtual);
      } else if (estadoAtual && !cidadeAtual) {
        zoomEstado(estadoAtual);
      } else if (estadoAtual && cidadeAtual) {
        zoomLocal(estadoAtual);
      }
    }

    // -------------------------
    // PESSOAS (pessoas.json)
    // -------------------------
    // URL da API do Google Apps Script (formul√°rio autom√°tico)
    const API_URL = "https://script.google.com/macros/s/AKfycbzcRPiOo3MFdBnMtKw8J1CdzLWuiKwPsm4EgOS1XseM5e9D0OJl0ougc4_0vmK3y0R1/exec";
    
    // Fallback para arquivo local se a API falhar (√∫til para desenvolvimento)
    const FALLBACK_JSON = "pessoas.json";

    function carregarPessoas() {
      // Tenta carregar da API primeiro
      fetch(API_URL)
        .then(resp => {
          if (!resp.ok) {
            throw new Error("Erro ao carregar dados da API");
          }
          return resp.json();
        })
        .then(data => {
          console.log("‚úì Dados carregados da API (Google Forms)");
          inicializarComDados(data);
        })
        .catch(err => {
          console.warn("‚ö† Falha ao carregar API, tentando arquivo local...", err);
          // Fallback para arquivo local
          fetch(FALLBACK_JSON)
            .then(resp => {
              if (!resp.ok) {
                throw new Error("Erro ao carregar pessoas.json");
              }
              return resp.json();
            })
            .then(data => {
              console.log("‚úì Dados carregados do arquivo local");
              inicializarComDados(data);
            })
            .catch(fallbackErr => {
              console.error("‚úó Erro ao carregar dados:", fallbackErr);
              summary.textContent = "Erro ao carregar dados de alumni.";
            });
        });
    }

    function inicializarComDados(data) {
      pessoas = data;
      popularFiltros();
      atualizarTurmas();
      atualizarInstituicoes();
      atualizarLista();
      if (estadosLayer) {
        estadosLayer.setStyle(estadoStyle);
      }
      ajustarZoom();
    }

    // Atualizar dados a cada 5 minutos (autom√°tico)
    setInterval(carregarPessoas, 5 * 60 * 1000);

    // -------------------------
    // FILTROS E LISTA
    // -------------------------
    function atualizarOpcoesEstado(regiao) {
      filterEstado.innerHTML = "";
      const optEstadoAll = document.createElement("option");
      optEstadoAll.value = "";
      optEstadoAll.textContent = regiao ? "Todos da regi√£o" : "Todos";
      filterEstado.appendChild(optEstadoAll);

      const instAtualNorm = normalizarTexto(filterInstituicao.value || "");

      let estados = [...new Set(pessoas.map((p) => p.estado_sigla).filter(Boolean))].sort();

      if (regiao) {
        estados = estados.filter((sigla) => stateRegionBySigla[sigla] === regiao);
      }

      if (instAtualNorm) {
        estados = estados.filter((sigla) => {
          return pessoas.some(p => {
            return p.estado_sigla === sigla && normalizarTexto(p.instituicao || "") === instAtualNorm;
          });
        });
      }

      estados.forEach((sigla) => {
        const opt = document.createElement("option");
        opt.value = sigla;
        opt.textContent = sigla;
        filterEstado.appendChild(opt);
      });
    }

    function popularFiltros() {
      const regioes = [...new Set(pessoas.map(p => p.regiao).filter(Boolean))].sort();
      regioes.forEach(r => {
        const opt = document.createElement("option");
        opt.value = r;
        opt.textContent = r;
        filterRegiao.appendChild(opt);
      });

      atualizarOpcoesEstado(null);
      atualizarCidades();
      atualizarTurmas();
    }

    function atualizarTurmas() {
      const regiaoAtual = filterRegiao.value;
      const estadoAtual = filterEstado.value;
      const cidadeAtual = filterCidade.value;

      filterTurma.innerHTML = "";
      const optAll = document.createElement("option");
      optAll.value = "";
      optAll.textContent = "Todas";
      filterTurma.appendChild(optAll);

      let filtradas = [...pessoas];

      if (regiaoAtual) {
        filtradas = filtradas.filter(p => p.regiao === regiaoAtual);
      }
      if (estadoAtual) {
        filtradas = filtradas.filter(p => p.estado_sigla === estadoAtual);
      }
      if (cidadeAtual) {
        filtradas = filtradas.filter(p => p.cidade === cidadeAtual);
      }

      const turmas = [...new Set(
        filtradas.map(p => p.turma).filter(Boolean)
      )].sort();

      turmas.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        filterTurma.appendChild(opt);
      });

      atualizarInstituicoes();
    }

    function atualizarInstituicoes() {
      if (!filterInstituicao) return;

      const regiaoAtual = filterRegiao.value;
      const estadoAtual = filterEstado.value;
      const cidadeAtual = filterCidade.value;
      const turmaAtual  = filterTurma.value;

      filterInstituicao.innerHTML = "";
      const optAll = document.createElement("option");
      optAll.value = "";
      optAll.textContent = "Todas";
      filterInstituicao.appendChild(optAll);

      let filtradas = [...pessoas];

      if (regiaoAtual) {
        filtradas = filtradas.filter(p => p.regiao === regiaoAtual);
      }
      if (estadoAtual) {
        filtradas = filtradas.filter(p => p.estado_sigla === estadoAtual);
      }
      if (cidadeAtual) {
        filtradas = filtradas.filter(p => p.cidade === cidadeAtual);
      }
      if (turmaAtual) {
        filtradas = filtradas.filter(p => p.turma === turmaAtual);
      }

      const instituicoes = [...new Set(
        filtradas.map(p => p.instituicao).filter(Boolean)
      )].sort();

      instituicoes.forEach(inst => {
        const opt = document.createElement("option");
        opt.value = inst;
        opt.textContent = inst;
        filterInstituicao.appendChild(opt);
      });
    }

    function atualizarCidades() {
      const regiaoAtual = filterRegiao.value;
      const estadoAtual = filterEstado.value;
      const instAtualNorm = normalizarTexto(filterInstituicao.value || "");

      filterCidade.innerHTML = "";
      const optAll = document.createElement("option");
      optAll.value = "";
      optAll.textContent = "Todas";
      filterCidade.appendChild(optAll);

      let filtradas = [...pessoas];

      if (regiaoAtual) {
        filtradas = filtradas.filter(p => p.regiao === regiaoAtual);
      }
      if (estadoAtual) {
        filtradas = filtradas.filter(p => p.estado_sigla === estadoAtual);
      }
      if (instAtualNorm) {
        filtradas = filtradas.filter(p => normalizarTexto(p.instituicao || "") === instAtualNorm);
      }

      const cidades = [...new Set(
        filtradas.map(p => p.cidade).filter(Boolean)
      )].sort();

      cidades.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        filterCidade.appendChild(opt);
      });

      atualizarTurmas();
    }

    function atualizarLista() {
      const regiaoAtual = filterRegiao.value;
      const estadoAtual = filterEstado.value;
      const cidadeAtual = filterCidade.value;
      const turmaAtual  = filterTurma.value;
      const instituicaoAtual = filterInstituicao.value;

      let filtradas = [...pessoas];

      if (regiaoAtual) {
        filtradas = filtradas.filter(p => p.regiao === regiaoAtual);
      }
      if (estadoAtual) {
        filtradas = filtradas.filter(p => p.estado_sigla === estadoAtual);
      }
      if (cidadeAtual) {
        filtradas = filtradas.filter(p => p.cidade === cidadeAtual);
      }
      if (turmaAtual) {
        filtradas = filtradas.filter(p => p.turma === turmaAtual);
      }
      if (instituicaoAtual) {
        filtradas = filtradas.filter(p => (p.instituicao || "") === instituicaoAtual);
      }

      summary.textContent =
        `${filtradas.length} pessoa(s) encontrada(s)` +
        (regiaoAtual || estadoAtual || cidadeAtual || turmaAtual || instituicaoAtual
          ? " com os filtros aplicados."
          : " no total.");

      peopleList.innerHTML = "";

      if (!filtradas.length) {
        if (estadoAtual) {
          summary.textContent = "Nenhuma pessoa cadastrada neste estado at√© o momento.";
          peopleList.innerHTML = `
            <div style="font-size:0.85rem; color:#6b7280; line-height:1.5;">
              <p>
                Nessa localidade ainda n√£o foram cadastrados alumni atuando (por enquanto!).
              </p>
              <p>
                Se voc√™ √© alumni do Ensina Brasil e est√° atuando aqui,
                <a href="https://forms.gle/K7C6H93niomnqaHPA" target="_blank" rel="noopener noreferrer">
                  preencha o formul√°rio de cadastro
                </a>
                para aparecer neste mapa.
              </p>
            </div>
          `;
        } else {
          summary.textContent = "Nenhuma pessoa encontrada com os filtros aplicados.";
          peopleList.textContent = "Nenhum registro encontrado para este filtro.";
        }
        return;
      }

      filtradas.forEach(p => {
        const div = document.createElement("div");
        div.className = "person-card";

        const key = criarChavePessoa(p);

        if (pessoaSelecionadaKey) {
          if (key === pessoaSelecionadaKey) {
            div.classList.add("selected");
          } else {
            div.classList.add("dimmed");
          }
        }

        div.innerHTML = `
  <div class="person-main-row">
    <!-- Nome √† esquerda -->
    <div class="person-main-left">
      <strong>${p.nome}</strong>
    </div>

    <!-- LinkedIn CENTRAL -->
    <div class="person-main-middle">
      ${
        p.linkedin
          ? `
            <span class="linkedin-line">
              <img class="linkedin-icon"
                   src="https://upload.wikimedia.org/wikipedia/commons/c/ca/LinkedIn_logo_initials.png"
                   alt="LinkedIn">
              <a href="${p.linkedin}" target="_blank">LinkedIn</a>
            </span>
          `
          : ""
      }
    </div>

    <!-- Cidade + bandeira √† direita -->
    <div class="person-main-right">
      <span>${p.cidade || ""} - ${p.estado_sigla || ""}</span>
      <img class="person-flag" src="bandeiras/${p.estado_sigla}.png" alt="Bandeira de ${p.estado_sigla}">
    </div>
  </div>
          <div class="person-bottom-row">
            <span class="badge badge-role">${p.funcao || "Sem fun√ß√£o"}</span>
            ${
              p.instituicao
                ? `<span class="badge badge-inst">${p.instituicao}</span>`
                : ""
            }
            <span class="badge badge-turma">Turma ${p.turma || "-"}</span>
          </div>
        `;

        div.addEventListener("click", () => selecionarPessoa(p));

        div.addEventListener("mouseenter", () => {
          const estadoPessoa = p.estado_sigla;
          const cidadeNorm = normalizarTexto(p.cidade || "");

          if (
            estadoPessoa &&
            filterEstado.value === estadoPessoa &&
            municipiosLayer &&
            currentMunicipiosUF === estadoPessoa
          ) {
            highlightCityNorm = cidadeNorm;
            municipiosLayer.setStyle(municipioStyle);
          }
        });

        div.addEventListener("mouseleave", () => {
          if (pessoaSelecionadaKey) {
            const partes = pessoaSelecionadaKey.split("|");
            const cidadeSel = partes[2] || "";
            const ufSel = partes[1] || "";

            highlightState = ufSel || null;
            highlightCityNorm = normalizarTexto(cidadeSel || "");
          } else {
            highlightState = filterEstado.value || null;
            highlightCityNorm = null;
          }

          if (municipiosLayer) {
            municipiosLayer.setStyle(municipioStyle);
          }
        });

        peopleList.appendChild(div);
      });
    }

    // -------------------------
    // EVENTOS DOS FILTROS E BOT√ïES
    // -------------------------
    filterRegiao.addEventListener("change", () => {
      const regiao = filterRegiao.value || "";

      // Atualiza vari√°veis de destaque
      selectedRegion = regiao || null;
      highlightState = null;
      highlightCityNorm = null;

      // Reseta demais filtros
      filterEstado.value = "";
      filterCidade.value = "";
      filterTurma.value = "";
      filterInstituicao.value = "";

      // Recalcula op√ß√µes dependentes
      atualizarOpcoesEstado(regiao || null);
      atualizarCidades();
      atualizarLista();

      // Reestiliza o mapa
      if (estadosLayer) {
        estadosLayer.setStyle(estadoStyle);
      }

      // Limpa munic√≠pios e ajusta zoom
      limparMunicipios();
      ajustarZoom();
    });

    filterEstado.addEventListener("change", () => {
      const est = filterEstado.value;

      if (est) {
        const regiao = stateRegionBySigla[est] || "";
        filterRegiao.value = regiao;
        selectedRegion = regiao || null;
        highlightState = est;
      } else {
        highlightState = null;
        if (!filterRegiao.value) {
          selectedRegion = null;
        }
      }

      highlightCityNorm = null;
      filterCidade.value = "";
      filterTurma.value = "";

      atualizarCidades();
      atualizarLista();

      if (estadosLayer) estadosLayer.setStyle(estadoStyle);
      if (municipiosLayer) municipiosLayer.setStyle(municipioStyle);

      ajustarZoom();
    });

    filterCidade.addEventListener("change", () => {
      // cidade mudou ‚Üí turmas e institui√ß√µes precisam ser recalculadas
      atualizarTurmas();       // isso j√° chama atualizarInstituicoes() por dentro
      atualizarLista();
      ajustarZoom();
    });

    filterTurma.addEventListener("change", () => {
      // turma mudou ‚Üí institui√ß√µes podem mudar
      atualizarInstituicoes();
      atualizarLista();
    });

    // üîπ AQUI √â O PONTO-CHAVE:
    // quando s√≥ a institui√ß√£o mudar, n√£o recalculamos os combos,
    // apenas refiltramos a lista com base na institui√ß√£o selecionada.
    filterInstituicao.addEventListener("change", () => {
      atualizarLista();
    });

    btnLimpar.addEventListener("click", limparSelecao);
    mapHomeBtn.addEventListener("click", limparSelecao);

    // -------------------------
    // INICIALIZA√á√ÉO
    // -------------------------
    document.addEventListener("DOMContentLoaded", () => {
      initMap();
      carregarPaisesVizinhos();
      adicionarProgramasTeachForAll();
      carregarPessoas();
      carregarEstados();
      adicionarLogosMunicipaisIniciais();
      criarLegendaEnsina();
      adicionarLogosLampiar(); // Lampiar no mapa
      try { updateLampiarIconsByZoom(); } catch (e) {}
      try { attachLampiarLegendHandlers(); } catch (e) {}

      const popupCloseBtn = document.getElementById("popup-close-btn");
      if (popupCloseBtn) {
        popupCloseBtn.addEventListener("click", hideNoAlumniPopup);
      }

      const popup = document.getElementById("no-alumni-popup");
      if (popup) {
        popup.addEventListener("click", (e) => {
          if (e.target === popup) {
            hideNoAlumniPopup();
          }
        });
      }
    });
  </script>
</body>
</html>
